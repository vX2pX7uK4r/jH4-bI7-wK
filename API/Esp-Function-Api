local hui = gethui()
local EspFunctionList = {}

function EspFunctionList:DrawingObjects(Object, config)
    local EspConfig = config or {}
    if Object then
        for _, BillboardGui in ipairs(hui:GetChildren()) do
            if BillboardGui.Adornee == Object then
                BillboardGui:FindFirstChild("Name").Text = EspConfig.CustomName or "nil"
                BillboardGui:FindFirstChild("Name").TextColor3 = EspConfig.Color3 or Color3.new(1, 1, 1)
                BillboardGui.StudsOffset = EspConfig.StudsOffset or Vector3.new(0.00, 0.00, 0.00)
                BillboardGui.Size = EspConfig.Size or UDim2.new(0.00, 100.00, 0.00, 40.00)
                BillboardGui.Name = EspConfig.BillboardGuiName or Object.Name
                BillboardGui:FindFirstChild("Distance").TextColor3 = EspConfig.DistanceColor3 or Color3.new(0.80, 0.80, 0.80)
                BillboardGui:FindFirstChild("Name").Visible = (EspConfig.NameVisible ~= nil) and EspConfig.NameVisible or true
                BillboardGui:FindFirstChild("Distance").Visible = (EspConfig.DistanceVisible ~= nil) and EspConfig.DistanceVisible or true
                if EspConfig.HighlightMode or false then
                    if BillboardGui:FindFirstChildOfClass("Highlight") then
                        BillboardGui:FindFirstChildOfClass("Highlight").FillColor = EspConfig.Color3 or Color3.new(1, 1, 1)
                    else
                        local Highlight = Instance.new("Highlight")
                        Highlight.OutlineTransparency = 1
                        Highlight.Adornee = Object
                        Highlight.FillColor = EspConfig.Color3 or Color3.new(1, 1, 1)
                        Highlight.FillTransparency = 0.6
                        Highlight.Parent = BillboardGui
                    end
                else
                    if BillboardGui:FindFirstChildOfClass("Highlight") then
                        BillboardGui:FindFirstChildOfClass("Highlight"):Destroy()
                    end
                end
                return "更新绘制:"..BillboardGui.Name
            end
        end

        local BillboardGui = Instance.new("BillboardGui")
        local Name = Instance.new("TextLabel")
        local Distance = Instance.new("TextLabel")
        BillboardGui.AlwaysOnTop = true
        BillboardGui.Name = EspConfig.BillboardGuiName or Object.Name
        BillboardGui.Size = EspConfig.Size or UDim2.new(0.00, 100.00, 0.00, 40.00)
        BillboardGui.ClipsDescendants = true
        BillboardGui.Adornee = Object
        BillboardGui.MaxDistance = math.huge
        BillboardGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        BillboardGui.StudsOffset = EspConfig.StudsOffset or Vector3.new(0.00, 0.00, 0.00)
        BillboardGui.Parent = hui
        Name.Name = "Name"
        Name.TextWrapped = true
        Name.TextStrokeTransparency = 0
        Name.TextScaled = true
        Name.FontFace = Font.new("rbxasset://fonts/families/SourceSansPro.json", Enum.FontWeight.Regular, Enum.FontStyle.Normal)
        Name.Size = UDim2.new(1.00, 0.00, 0.50, 0.00)
        Name.Text = EspConfig.CustomName or Object.Name or "nil"
        Name.TextColor3 = EspConfig.Color3 or Color3.new(1, 1, 1)
        Name.BackgroundTransparency = 1
        Name.Parent = BillboardGui
        Name.Visible = (EspConfig.NameVisible ~= nil) and EspConfig.NameVisible or true
        Distance.Name = "Distance"
        Distance.TextWrapped = true
        Distance.TextStrokeTransparency = 0.4000000059604645
        Distance.TextScaled = true
        Distance.FontFace = Font.new("rbxasset://fonts/families/SourceSansPro.json", Enum.FontWeight.Regular, Enum.FontStyle.Normal)
        Distance.Size = UDim2.new(1.00, 0.00, 0.50, 0.00)
        Distance.Text = "[无数据]"
        Distance.TextColor3 = EspConfig.DistanceColor3 or Color3.new(0.80, 0.80, 0.80)
        Distance.BackgroundTransparency = 1
        Distance.Position = UDim2.new(0.00, 0.00, 0.50, 0.00)
        Distance.Parent = BillboardGui
        Distance.Visible = (EspConfig.DistanceVisible ~= nil) and EspConfig.DistanceVisible or true
        if EspConfig.HighlightMode or false then
            local Highlight = Instance.new("Highlight")
            Highlight.OutlineTransparency = 1
            Highlight.Adornee = EspConfig.HighlightAdornee or Object
            Highlight.FillColor = EspConfig.Color3 or Color3.new(1, 1, 1)
            Highlight.FillTransparency = 0.6
            Highlight.Parent = BillboardGui
        end
        return "创建绘制:"..BillboardGui.Name
    end
end

function EspFunctionList:DestroyDrawing(BillboardGuiName)
    if BillboardGuiName then
        for _, BillboardGui in ipairs(hui:GetChildren()) do
            if BillboardGui.Name == BillboardGuiName then
                BillboardGui:Destroy()
                return "销毁绘制:"..BillboardGuiName
            end
        end
    end
end

function EspFunctionList:GetDrawingList()
    local billboardGuis = {}
    local adorneeCount = {}
    for _, child in ipairs(hui:GetChildren()) do
        if child:IsA("BillboardGui") then
            local adorneeName = child.Adornee and child.Adornee.Name or "无绑定对象"
            table.insert(billboardGuis, {
                Name = child.Name,
                Adornee = adorneeName
            })
            adorneeCount[adorneeName] = (adorneeCount[adorneeName] or 0) + 1
        end
    end
    local statusText = ""
    for adorneeName, count in pairs(adorneeCount) do
        if statusText ~= "" then
            statusText = statusText .. ", "
        end
        statusText = statusText .. string.format("%s(%d)", adorneeName, count)
    end
    if #billboardGuis == 0 then
        print("当前绘制数量: 0")
    else
        print(string.format("当前绘制数量: %d | 绑定状态: %s", #billboardGuis, statusText))
    end
    return billboardGuis
end

function EspFunctionList:Help()
print([[
(Beta)
===ESP 绘制系统帮助===
• DrawingObjects(Object, config) - 创建/更新ESP绘制
  参数: Object(目标对象), config(配置表)
  配置选项:
    - CustomName: 自定义显示名称
    - BillboardGuiName: 自定义BillboardGui名称
    - HighlightAdornee: 自定义高亮显示对象 (Object)
    - StudsOffset: 偏移位置 (Vector3)
    - Size: 显示大小 (UDim2)
    - Color3: 显示颜色 (Color3)
    - DistanceColor3: 距离显示颜色 (Color3)
    - HighlightMode: 高亮显示 (true/false)
    - NameVisible: 名称显示 (true/false)
    - DistanceVisible: 距离显示 (true/false)
======================================
• DestroyDrawing(BillboardGuiName) - 销毁指定名字的绘制
  参数: BillboardGuiName(BillboardGui名称)
====================================== 
• GetDrawingList() - 获取当前所有绘制列表
  return(返回Tabel): 包含所有绘制名称和绑定对象名称的表
======================================
• Help() - 显示此帮助信息
]])
end

game:GetService("RunService").Stepped:Connect(function()
    if game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        for _, BillboardGui in ipairs(hui:GetChildren()) do
            if BillboardGui:IsA("BillboardGui") then
                if BillboardGui.Adornee == nil or BillboardGui.Adornee.Parent == nil then
                    BillboardGui:Destroy()
                end
            end
        end
        for _, BillboardGui in ipairs(hui:GetChildren()) do
            if BillboardGui:IsA("BillboardGui") and BillboardGui.Adornee then
                local DistanceLabel = BillboardGui:FindFirstChild("Distance")
                if DistanceLabel and game.Players.LocalPlayer.Character then
                    local AdorneePosition = BillboardGui.Adornee:IsA("BasePart") and BillboardGui.Adornee.Position or BillboardGui.Adornee:GetPivot().Position
                    DistanceLabel.Text = "["..math.floor((AdorneePosition - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude).."m]"
                end
            end
        end
    end
end)

print("[绘制(Beta)]初始化成功")
print("使用Help()查看帮助")

return EspFunctionList
