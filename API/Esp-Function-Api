local hui = gethui()
local EspFunctionList = {}
local CustomConfigurationTable = {}
local function getVisibility(configValue)
    if configValue == nil then
        return true
    else
        return configValue
    end
end

function EspFunctionList:DrawingObjects(Required, EspConfig)
    if not Required then return "Required参数为空" end
    if not Required.Object then return "Required.Object必须设置" end
    if Required.CustomText == nil then return "错误: Required.CustomText 必须设置" end
    if Required.BillboardGuiAdornee == nil then return "错误: Required.BillboardGuiAdornee 必须设置" end
    if not EspConfig then EspConfig = {} end
    local Object = Required.Object
    local color3 = EspConfig.Color3 or Color3.new(1, 1, 1)
    local billboardGuiAdornee = Required.BillboardGuiAdornee
    local distanceColor3 = EspConfig.DistanceColor3 or Color3.new(1, 1, 1)
    local textTransparency = EspConfig.TextTransparency or 0
    local highlightTransparency = EspConfig.HighlightTransparency or 0.6
    local studsOffset = EspConfig.StudsOffset or Vector3.new(0, 0, 0)
    local studsOffsetWorldSpace = EspConfig.StudsOffsetWorldSpace or Vector3.new(0, 0, 0)
    local size = EspConfig.Size or UDim2.new(0, 100, 0, 40)
    local billboardName = Required.BillboardGuiName or Object.Name
    local CustomText = Required.CustomText
    local nameVisible = getVisibility(EspConfig.NameVisible)
    local distanceVisible = getVisibility(EspConfig.DistanceVisible)
    local searchAdornee = billboardGuiAdornee
    local existingBillboard = nil
    for _, child in ipairs(hui:GetChildren()) do
        if child:IsA("BillboardGui") and child.Adornee == searchAdornee then
            existingBillboard = child
            break
        end
    end
    if existingBillboard and existingBillboard:IsA("BillboardGui") then
        local nameTextLabel = existingBillboard:FindFirstChild("Name")
        local distanceTextLabel = existingBillboard:FindFirstChild("Distance")
        if nameTextLabel and nameTextLabel:IsA("TextLabel") then
            nameTextLabel.Text = CustomText
            nameTextLabel.TextColor3 = color3
            nameTextLabel.Visible = nameVisible
            nameTextLabel.TextTransparency = textTransparency
        end
        if distanceTextLabel and distanceTextLabel:IsA("TextLabel") then
            distanceTextLabel.TextColor3 = distanceColor3
            distanceTextLabel.Visible = distanceVisible
            distanceTextLabel.TextTransparency = textTransparency
        end
        existingBillboard.Name = billboardName
        existingBillboard.MaxDistance = EspConfig.MaxDistance or math.huge
        existingBillboard.StudsOffset = studsOffset
        existingBillboard.Size = size
        existingBillboard.StudsOffsetWorldSpace = studsOffsetWorldSpace
        existingBillboard.Adornee = searchAdornee
        local existingHighlight = existingBillboard:FindFirstChildWhichIsA("Highlight")
        local highlightAdornee = EspConfig.HighlightAdornee
        if highlightAdornee then
            local targetAdornee = Object
            if type(highlightAdornee) == "string" then
                targetAdornee = Object:FindFirstChild(highlightAdornee) or Object
            else
                targetAdornee = highlightAdornee
            end
            if existingHighlight then
                existingHighlight.FillColor = color3
                existingHighlight.FillTransparency = highlightTransparency
                existingHighlight.Adornee = targetAdornee
            else
                local highlight = Instance.new("Highlight")
                highlight.OutlineTransparency = 1
                highlight.Adornee = targetAdornee
                highlight.FillColor = color3
                highlight.FillTransparency = highlightTransparency
                highlight.Parent = existingBillboard
            end
        else
            if existingHighlight then
                existingHighlight:Destroy()
            end
        end
        return "更新绘制:" .. existingBillboard.Name
    else
        local billboardGui = Instance.new("BillboardGui")
        billboardGui.AlwaysOnTop = true
        billboardGui.Name = billboardName
        billboardGui.Size = size
        billboardGui.ClipsDescendants = true
        billboardGui.Adornee = searchAdornee
        billboardGui.MaxDistance = EspConfig.MaxDistance or math.huge
        billboardGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        billboardGui.StudsOffsetWorldSpace = studsOffsetWorldSpace
        billboardGui.StudsOffset = studsOffset
        billboardGui.Parent = hui
        local font = Font.new("rbxasset://fonts/families/SourceSansPro.json")
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Name = "Name"
        nameLabel.TextWrapped = false
        nameLabel.TextStrokeTransparency = 0
        nameLabel.TextScaled = true
        nameLabel.FontFace = font
        nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
        nameLabel.Text = CustomText
        nameLabel.TextColor3 = color3
        nameLabel.BackgroundTransparency = 1
        nameLabel.TextTransparency = textTransparency
        nameLabel.Visible = nameVisible
        nameLabel.Parent = billboardGui
        local distanceLabel = Instance.new("TextLabel")
        distanceLabel.Name = "Distance"
        distanceLabel.TextWrapped = false
        distanceLabel.TextStrokeTransparency = 0.4
        distanceLabel.TextScaled = true
        distanceLabel.FontFace = font
        distanceLabel.Size = UDim2.new(1, 0, 0.5, 0)
        distanceLabel.Text = "[无数据]"
        distanceLabel.TextTransparency = textTransparency
        distanceLabel.TextColor3 = distanceColor3
        distanceLabel.BackgroundTransparency = 1
        distanceLabel.Position = UDim2.new(0, 0, 0.5, 0)
        distanceLabel.Visible = distanceVisible
        distanceLabel.Parent = billboardGui
        local highlightAdornee = EspConfig.HighlightAdornee
        if highlightAdornee then
            local targetAdornee = Object
            if type(highlightAdornee) == "string" then
                targetAdornee = Object:FindFirstChild(highlightAdornee) or Object
            else
                targetAdornee = highlightAdornee
            end
            local highlight = Instance.new("Highlight")
            highlight.OutlineTransparency = 1
            highlight.Adornee = targetAdornee
            highlight.FillColor = color3
            highlight.FillTransparency = highlightTransparency
            highlight.Parent = billboardGui
        end
        return "创建绘制:" .. billboardGui.Name
    end
end


function EspFunctionList:DestroyDrawing(Object)
    if Object then
        if not type(Object) == "string" then
            for _, BillboardGui in ipairs(hui:GetChildren()) do
                if BillboardGui:IsA("BillboardGui") and BillboardGui.Adornee == Object then
                    BillboardGui:Destroy()
                    return "(Object)销毁绘制:"..Object.Name
                end
            end
        else
            for _, BillboardGui in ipairs(hui:GetChildren()) do
                if BillboardGui:IsA("BillboardGui") and BillboardGui.Name == Object then
                    BillboardGui:Destroy()
                    return "(Name)销毁绘制:"..Object
                end
            end
        end
    end
end

function EspFunctionList:DestroyAllDrawing()
    local count = 0
    for _, BillboardGui in ipairs(hui:GetChildren()) do
        if BillboardGui:IsA("BillboardGui") then
            BillboardGui:Destroy()
            count = count + 1
        end
    end
    return "销毁所有绘制,数量:"..count
end

function EspFunctionList:GetDrawingList(showAdornee, shouldPrint)
    local billboardGuis = {}
    local countTable = {}
    for _, child in ipairs(hui:GetChildren()) do
        if child:IsA("BillboardGui") then
            local adorneeName = child.Adornee and child.Adornee.Name or "无绑定对象"
            table.insert(billboardGuis, {
                Name = child.Name,
                Adornee = adorneeName
            })
            local key = showAdornee and adorneeName or child.Name
            countTable[key] = (countTable[key] or 0) + 1
        end
    end
    if shouldPrint then
        local statusText = ""
        for name, count in pairs(countTable) do
            if statusText ~= "" then
                statusText = statusText .. ", "
            end
            statusText = statusText .. string.format("%s(%d)", name, count)
        end
        if #billboardGuis == 0 then
            print("当前绘制数量: 0")
        else
            local displayType = showAdornee and "绑定对象(Adornee)" or "绘制名称(Name)"
            print(string.format("当前绘制数量: %d | %s状态: %s", #billboardGuis, displayType, statusText))
        end
    end
    return billboardGuis
end

function EspFunctionList:AddConfiguration(Name, config, delete)
    local success, result = pcall(function()
        if type(Name) ~= "string" then
            return "配置名称必须是字符串"
        end
        if type(CustomConfigurationTable) ~= "table" then
            CustomConfigurationTable = {}
        end
        if delete == true then
            if CustomConfigurationTable[Name] == nil then
                return "找不到名为 '"..Name.."' 的配置"
            end
            CustomConfigurationTable[Name] = nil
            return "成功删除配置 '"..Name.."'"
        end
        if type(config) ~= "table" then
            return "配置内容必须是表"
        end
        CustomConfigurationTable[Name] = config
        return "名为"..Name.."的配置添加成功\n"..game:GetService("HttpService"):JSONEncode(config)
    end)
    if success then
        return result
    else
        return "操作失败: " .. tostring(result)
    end
end

function EspFunctionList:GetConfiguration(Name)
    local success, result = pcall(function()
        if type(CustomConfigurationTable) ~= "table" then
            CustomConfigurationTable = {}
            return "配置表为空"
        end
        if Name == nil then
            return CustomConfigurationTable
        end
        if type(Name) ~= "string" then
            return "配置名称必须是字符串"
        end
        if CustomConfigurationTable[Name] == nil then
            return "找不到名为 '"..Name.."' 的配置"
        end
        return CustomConfigurationTable[Name]
    end)
    if success then
        return result
    else
        return "获取配置失败: " .. tostring(result)
    end
end

function EspFunctionList:Help()
print([[
(Beta)
===ESP 绘制系统帮助===
• DrawingObjects(Required, EspConfig) - 创建/更新ESP绘制
  参数: Required(必须参数 表), EspConfig(可选配置 表)
  return(返回字符串): 创建/更新状态
  Required参数说明:
    Object(目标对象 必须 BasePart/Model/Folder等),
    CustomText(自定义文本 必须 字符串),
    BillboardGuiAdornee(BillboardGui绑定对象 必须 实例)
    BillboardGuiName(BillboardGui名称 字符串 默认Object.Name)
  EspConfig参数说明(均为可选):
    CustomName(自定义名称 字符串 默认Object.Name)
    HighlightAdornee(高亮绑定对象 字符串/实例 默认无)
    StudsOffset(偏移位置 Vector3 默认Vector3.new(0,3,0))
    StudsOffsetWorldSpace(世界空间偏移位置 Vector3 默认Vector3.new(0,0,0))
    Size(BillboardGui大小 UDim2 默认UDim2.new(0,100,0,40))
    Color3(文本颜色 Color3 默认Color3.new(1,1,1))
    DistanceColor3(距离文本颜色 Color3 默认Color3.new(1,1,1))
    NameVisible(名称可见性 布尔值 true/false 默认true)
    DistanceVisible(距离可见性 布尔值 true/false 默认true)
    HighlightTransparency(高亮透明度 数值 0-1 默认0.6)
    TextTransparency(文本透明度 数值 0-1 默认0)
    MaxDistance(BillboardGui最大显示距离 数值 默认math.huge)
======================================
• DestroyDrawing(Object) - 销毁指定ESP绘制
  参数: Object(目标对象/名称)
  return(返回字符串): 销毁状态
====================================== 
• DestroyAllDrawing() - 销毁所有绘制
  return(返回字符串): 销毁数量
====================================== 
• GetDrawingList(showAdornee, shouldPrint) - 获取当前所有绘制列表
  参数: showAdornee(显示绑定对象名称 true/false 默认false), shouldPrint(是否打印设置 true/false 默认false)
  return(返回表): 包含所有绘制信息的表格
======================================
• AddConfiguration(Name, config, delete) - 添加/删除自定义配置
  参数: Name(配置名称), config(配置内容 表), delete(删除配置 true/false 默认false)
  return(返回字符串): 操作状态
======================================
• GetConfiguration(Name) - 获取自定义配置
  参数: Name(配置名称 可选)
  return(返回表/字符串): 配置内容/操作状态
======================================
• Help() - 显示此帮助信息
]])
end

game:GetService("RunService").RenderStepped:Connect(function()
    if game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        for _, BillboardGui in ipairs(hui:GetChildren()) do
            if BillboardGui:IsA("BillboardGui") and BillboardGui.Adornee then
                local DistanceLabel = BillboardGui:FindFirstChild("Distance")
                if DistanceLabel then
                    local success, distance = pcall(function()
                        local AdorneePosition = BillboardGui.Adornee:IsA("BasePart") and BillboardGui.Adornee.Position or BillboardGui.Adornee:GetPivot().Position
                        return math.floor((AdorneePosition - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude)
                    end)
                    if success then
                        DistanceLabel.Text = "["..distance.."m]"
                    else
                        BillboardGui:Destroy()
                    end
                end
            end
        end
    end
end)

spawn(function()
    while task.wait(20) do
        for _, BillboardGui in ipairs(hui:GetChildren()) do
            if BillboardGui:IsA("BillboardGui") then
                if BillboardGui.Adornee and BillboardGui.Adornee.Parent then
                    local success, result = pcall(function()
                        return game.Workspace:FindFirstChild(BillboardGui.Adornee.Parent.Name, true) == nil
                    end)
                    if success and result then
                        BillboardGui:Destroy()
                    end
                else
                    BillboardGui:Destroy()
                end
            end
        end
    end
end)


print("[绘制(Beta)]Api初始化成功,使用Help()查看帮助")

return EspFunctionList
